name: 0_append_artifact_url

on:
  # artifactのURLはJob実行中には取得できないため、workflow_runのcompletedイベントを利用する
  workflow_run:
    workflows:
      - "0_pr_update"
    types:
      - "completed"

jobs:
  add_comment:
    runs-on: ubuntu-latest
    steps:
      - name: "📌 Get Artifact Information"
        id: get_artifact
        uses: actions/github-script@v7
        with:
          script: |
            const eventObj = ${{ toJSON(github.event.workflow_run) }};
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: eventObj.id
            });
            const artifact = artifacts.data.artifacts.filter(artifact => artifact.expired === false)[0];
            if (artifact) {
              core.setOutput('artifact_id', artifact.id);
              const downloadUrl = "${{ github.server_url }}/${{ github.repository }}/suites/" + `${eventObj.check_suite_id}/artifacts/${artifact.id}`;
              core.setOutput('artifact_url', downloadUrl);
            }
            // context.issue.numberはPRの番号
            core.setOutput('issue_number', eventObj.pull_requests[0].number);
            core.setOutput('head_sha', context.sha);

      - name: "🔎 Find Comment"
        uses: peter-evans/find-comment@v2
        id: find_comment
        if: ${{ steps.get_artifact.outputs.artifact_id != '' }}
        with:
          issue-number: ${{ steps.get_artifact.outputs.issue_number }}
          comment-author: "github-actions[bot]"
          body-includes: "Semgrep Analysis"
          direction: last

      - name: "🦜 Update Comment"
        uses: peter-evans/create-or-update-comment@v3
        if: ${{ steps.find_comment.outputs.comment-id != '' }}
        with:
          issue-number: ${{ steps.get_artifact.outputs.issue_number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          body: |-
            #### 🎁 Semgrep Artifact

            ![badge]
            You can download the semgrep sarif file from the link below.
            Please note that file only stay for around 90 days!

            | Name        | Link                    |
            | ----------- | ----------------------- |
            | Commit      | ${{ steps.get_artifact.outputs.head_sha }}     |
            | Artifact    | [${{ steps.get_artifact.outputs.artifact_id }}](${{ steps.get_artifact.outputs.artifact_url }}) |

            [badge]: https://img.shields.io/badge/Build-Success!-3fb950?logo=github&style=for-the-badge
