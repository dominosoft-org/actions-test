name: 0_append_artifact_url

on:
  # artifactã®URLã¯Jobå®Ÿè¡Œä¸­ã«ã¯å–å¾—ã§ããªã„ãŸã‚ã€workflow_runã®completedã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ©ç”¨ã™ã‚‹
  workflow_run:
    workflows:
      - "0_pr_update"
    types:
      - "completed"

jobs:
  add_comment:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Œ Get Artifact Information
        id: get_artifact
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const eventObj = ${{ toJSON(github.event.workflow_run) }};
            if (!eventObj.pull_requests?.length) {
              // ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒèµ°ã‚‹å‰ã«PRãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã€pull_requestsã¯ç©ºã®é…åˆ—ã¨ãªã‚‹ã€‚
              // ã“ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ã€‚
              return;
            }
            core.setOutput('issue_number', eventObj.pull_requests[0].number);
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: eventObj.id
            });
            const validArtifacts = artifacts.data.artifacts.filter(artifact => artifact.expired === false);
            if (!validArtifacts.length) {
              // ArtifactãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„ã€‚
              return;
            }
            let result = "### :gift: Semgrep Artifact\n\n";
            result += "![badge]\n";
            result += "You can download the semgrep sarif file from the link below.\n";
            result += "Please note that file only stay for around 90 days!\n\n";
            result += "| Artifact ID | Link                    |\n";
            result += "| ----------- | ----------------------- |\n";
            for (const artifact of validArtifacts.data.artifacts) {
              const downloadUrl = "${{ github.server_url }}/${{ github.repository }}/suites/" + `${eventObj.check_suite_id}/artifacts/${artifact.id}`;
              result += `| ${artifact.id} | ${downloadUrl} |\n`;
            }
            result += "\n[badge]: https://img.shields.io/badge/Build-Success!-3fb950?logo=github&style=for-the-badge\n";
            return result;

      - name: ğŸ” Find Comment
        uses: peter-evans/find-comment@v2
        id: find_comment
        if: ${{ steps.get_artifact.outputs.result != '' }}
        with:
          issue-number: ${{ steps.get_artifact.outputs.issue_number }}
          comment-author: "github-actions[bot]"
          body-includes: "Semgrep Analysis"
          direction: last

      - name: ğŸ¦œ Update Comment
        uses: peter-evans/create-or-update-comment@v3
        if: ${{ steps.find_comment.outputs.comment-id != '' }}
        with:
          issue-number: ${{ steps.get_artifact.outputs.issue_number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          body: ${{ steps.get_artifact.outputs.result }}
