name: 2_back_sonarqube

on:
  workflow_call:
    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_HOST_URL:
        required: true
    inputs:
      solution_directory:
        description: "slnãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã¸ã®ãƒ‘ã‚¹ï¼ˆworkspaceãƒ‘ã‚¹ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ï¼‰"
        type: string
        required: true
      sonar_project:
        description: "SonaQubeã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå"
        type: string
        required: true
    outputs:
      result:
        value: ${{ jobs.check.outputs.result }}

jobs:
  check:
    runs-on: windows-latest
    outputs:
      result: ${{ steps.create_comment.outputs.result }}
    steps:
      - name: ğŸ’¼ Checkout
        uses: actions/checkout@v4
      - name: âš¡ Setup Nuget Cache
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: ğŸ–¥ï¸ Setup MSBuild
        uses: microsoft/setup-msbuild@v1
      - name: ğŸš€ Install dotnet-sonarscanner tool
        run: |
          cd ./${{ inputs.solution_directory }}
          dotnet new tool-manifest
          dotnet tool install --local dotnet-sonarscanner
      - name: ğŸ‘€ Sonar scan
        id: sonar_scan
        run:
          cd ./${{ inputs.solution_directory }}
          dotnet restore --configfile "github-actions-nuget.config"
          dotnet sonarscanner begin /k:"${{ inputs.sonar_project }}" /d:sonar.token="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="${{ secrets.SONAR_HOST_URL }}"
          msbuild -m -p:Configuration=Release -p:IsGithubActions=true -verbosity:quiet
          dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
      - name: ğŸ–Šï¸ Create Comment
        id: create_comment
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            let result = "### :cyclone: Backend Cognitive Complexity Check\n\n"
            result += "${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ inputs.sonar_project }}\nLogin account: browse"
            return result;
