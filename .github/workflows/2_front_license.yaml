name: 2_front_license

on:
  workflow_call:
    outputs:
      comment:
        value: ${{ jobs.check.outputs.comment }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      comment: ${{ steps.create_comment.outputs.comment }}
    steps:
      - name: ðŸ’¼ Checkout
        uses: actions/checkout@v4

      - name: ðŸ–¥ï¸ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: ðŸ–¥ï¸ Setup pnpm
        uses: pnpm/action-setup@v2
        id: pnpm-setup
        with:
          version: latest
          run_install: false

      - name: ðŸ’¾ Get pnpm Store Directory
        id: pnpm_cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: âš¡ Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm_cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('./frontend/**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¦ Install Dependencies
        run: |
          # Globalã«license-checker-rseidelsohnã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pnpm install -g license-checker-rseidelsohn
          # ä¸‹è¨˜ã‚³ãƒžãƒ³ãƒ‰ã§ã€directoriesã«ã¯./frontend/ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ•ãƒ«ãƒ‘ã‚¹ãŒæ ¼ç´ã•ã‚Œã‚‹
          directories=($(ls -d ./frontend/*/ | xargs -n1 readlink -f))
          for i in "${!directories[@]}"; do
            cd ${directories[$i]}
            pnpm install
          done

      - name: ðŸ‘€ Check License
        run: |
          # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹OKã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã€ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹
          excludeLicenses=$(cat ./license-whitelist.json | jq -r '.excludeLicenses | join(",")')
          # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹OKã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åï¼ˆå…ˆé ­ã‹ã‚‰ã®éƒ¨åˆ†ä¸€è‡´ã§ä½¿ç”¨ã™ã‚‹ï¼‰ã‚’å–å¾—ã—ã€ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹
          excludePackages=$(cat ./license-whitelist.json | jq -r '.excludePackages | join(",")')
          directories=($(ls -d ./frontend/*/ | xargs -n1 readlink -f))
          for i in "${!directories[@]}"; do
            cd ${directories[$i]}
            license-checker-rseidelsohn --production --csv --excludeLicenses "${excludeLicenses}" --excludePackagesStartingWith "${excludePackages}" --out ./lc.csv
            # ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ä¸è¦ãªã®ã§1è¡Œç›®ã‚’å‰Šé™¤ã—ã¦ãŠã
            sed -e '1d' -i ./lc.csv
          done

      - name: ðŸ–Šï¸ Create Comment
        id: create_comment
        run: |
          # ã™ã¹ã¦ã®lc.csvã®çµæžœã‹ã‚‰é‡è¤‡ã‚’æŽ’é™¤ã—ãŸé…åˆ—ã‚’å–å¾—ã™ã‚‹ã€‚
          lines=$(sort -u -s ./frontend/*/lc.csv)
          result="### ðŸ“„Frontend License Check\n\n"
          if [ -z "$lines" ]; then
            # ã™ã¹ã¦ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒOKã®å ´åˆ
            result+="âœ…All OK."
          else
            # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹NGãŒã‚ã‚‹å ´åˆ
            log="ðŸ¤·Is it safe to use these libraries? Reviewers must judge that.\n\n"
            log+=$(echo "- ${lines}" | sed -n '/,/,$p')
            log="${log//$'\n'/\\n}"
            result+="$log"
          fi
          echo "comment=${result}" >> "$GITHUB_OUTPUT"
