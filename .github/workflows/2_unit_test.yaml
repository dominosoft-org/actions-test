name: 2_unit_test

on:
  workflow_call:
    secrets:
      REPO_ACCOUNT:
        required: true
      REPO_ACCESS_TOKEN:
        required: true
    outputs:
      comment:
        value: ${{  jobs.merge_comment.outputs.comment  }}

env:
  GITHUB_ACCOUNT: ${{  secrets.REPO_ACCOUNT  }}
  GITHUB_PKG_NFW_AUTH_TOKEN: ${{  secrets.REPO_ACCESS_TOKEN  }}

jobs:
  unit_test:
    runs-on: windows-latest
    outputs:
      comment: ${{ steps.create_comment.outputs.comment }}

    steps:
      - name: CheckoutðŸ›Žï¸
        uses: actions/checkout@v4

      - name: Setup Nuget cacheâš¡
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v1

      - name: Setup VSTest Path
        uses: darenm/Setup-VSTest@v1.2

      - name: Generate Unit Test Report
        run: |
          cd .\backend\NeuroFramework.Common
          dotnet restore -p:WarningsNotAsErrors=NU1603 -p:NoWarn=NU1603 --configfile "github-actions-nuget.config"
          msbuild /m /p:Configuration=Release -verbosity:quiet
          vstest.console.exe /platform:x64 /inIsolation /Blame /Logger:trx /Enablecodecoverage .\tests\NeuroFramework.*\bin\Release\net7.0\**.Tests.dll /collect:"Code Coverage;Format=Cobertura"

      - name: Test Report
        if: ${{ !cancelled() }}
        id: test_report
        uses: phoenix-actions/test-reporting@v12
        with:
          name: Unit Tests Report
          path: "./backend/NeuroFramework.Common/TestResults/**.trx"
          reporter: dotnet-trx
          fail-on-error: "true"
          only-summary: "false"
          list-suites: "all"
          list-tests: "all"

      - name: Create Comment
        if: ${{ !cancelled() }}
        id: create_comment
        run: |
          comment="### Backend Unit Test\n\n"
          comment="Check The Unit Test Report: **${{ steps.test_report.outputs.runHtmlUrl }}**\n\n"
          echo "comment=${comment}" > "$GITHUB_OUTPUT"

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v3
        if: ${{ !cancelled() }}
        with:
          name: code coverage report
          path: .\backend\NeuroFramework.Common\TestResults\**\*.cobertura.xml

  code_coverage_report:
    needs: unit_test
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    outputs:
      comment: ${{ steps.create_comment.outputs.comment }}
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: code coverage report
          path: coveragereport/

      - name: Code Coverage Report
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coveragereport/**/*.cobertura.xml
          badge: true
          fail_below_min: false
          format: markdown
          hide_branch_rate: false
          hide_complexity: true
          indicators: true
          output: both
          thresholds: "60 80"

      - name: Upload Coverage Result Report
        uses: actions/upload-artifact@v3
        if: ${{ !cancelled() }}
        with:
          name: code coverage markdown report
          path: code-coverage-results.md

      - name: Create Comment
        if: ${{ !cancelled() }}
        id: create_comment
        run: |
          comment="$(cat code-coverage-results.md)\n\n"
          echo "comment=${comment}" > "$GITHUB_OUTPUT"

  merge_comment:
    needs: [ unit_test, code_coverage_report ]
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    outputs:
      comment: ${{ steps.merge_comments.outputs.comment }}
    steps:
      - name: Merge Comments
        id: merge_comments
        run: |
          comments=('${{ needs.unit_test.outputs.comment }}' '${{ needs.code_coverage_report.outputs.comment }}')
          for i in ${!comments[@]}; do
            if [ "${comments[$i]}" != "" ]; then
              merged_comment+="${comments[$i]}\n\n"
            fi
          done
          echo "comment=$(echo ${merged_comment})" > "$GITHUB_OUTPUT"
