name: frontend semgrep

on:
  workflow_call:
    outputs:
      result:
        value: ${{ jobs.create-table.outputs.comment }}

jobs:
  semgrep:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout🛎️
        uses: actions/checkout@v4
      - name: Create Command
        id: create-command
        run: |
          config=$(cat ./devtools/semgrep/semgrep-frontend.config|tr '\n' ' '|sed -e 's/ $/\n/g')
          semgrep_command_args=$(echo "scan $config ./frontend --sarif --output ./frontend/frontend.sarif")
          echo "args=$(echo $semgrep_command_args)" >> "$GITHUB_OUTPUT"
      - name: Scan🌈
        id: scan
        uses: docker://returntocorp/semgrep:1.48.0
        with:
          entrypoint: "semgrep"
          args: ${{ steps.create-command.outputs.args }}
      - name: Upload Report📑
        uses: actions/upload-artifact@v3
        with:
          name: semgrep frontend report
          path: |
            ./frontend/frontend.sarif
            ./devtools/semgrep/semgrep-rule-info-generation.sh
            ./devtools/semgrep/semgrep-report-generation.sh

  analyze-report:
    name: Analyze Report
    needs: semgrep
    uses: ./.github/workflows/semgrep-report.yaml
    with:
      location: frontend
      descriptionKey: .fullDescription.text

  create-table:
    uses: ./.github/workflows/semgrep-table.yaml
    needs: analyze-report
    with:
      length: ${{ needs.analyze-report.outputs.length }}
      location: ${{ needs.analyze-report.outputs.location }}
      findings: ${{ needs.analyze-report.outputs.findings }}
      message: ${{ needs.analyze-report.outputs.message }}

  judge-reject:
    needs: analyze-report
    if: needs.analyze-report.outputs.reject > 0
    runs-on: ubuntu-latest
    steps:
      - run: exit 1
