name: run on pull request update

on:
  workflow_dispatch:
  pull_request:
    branches:
      - "main"
    types:
      - opened
      - synchronize
    # pathsによるfilterは、dorny/paths-filterで行う

jobs:
  # プルリクエストの更新時に、変更されたファイルを解析し、走らせるワークフローを選択する。
  changes:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}
    outputs:
      backend-any: ${{ steps.filters.outputs.backend-any }}
      frontend-any: ${{ steps.filters.outputs.frontend-any }}
      docfx-any: ${{ steps.changes.outputs.docfx-any }}
      backend-common-any: ${{ steps.filters.outputs.backend-common-any }}
      backend-fakes-any: ${{ steps.filters.outputs.backend-fakes-any }}
      pnpm-lock: ${{ steps.filters.outputs.pnpm-lock }}
      csproj: ${{ steps.filters.outputs.csproj }}
    steps:
      - name: Checkout🛎️
        uses: actions/checkout@v4
      - name: Filter changes🔎
        uses: dorny/paths-filter@v2
        id: filters
        with:
          filters: |
            backend-any:
              - 'backend/**'
            frontend-any:
              - 'frontend/**'
            docfx-any:
              - 'doc/docfx/**'
            backend-common-any:
              - 'backend/NeuroFramework.Common/**'
            backend-fakes-any:
              - 'backend/FakesAssemblies/**'
            pnpm-lock:
              - '**/pnpm-lock.yaml'
            csproj:
              - 'backend/NeuroFramework.Common/**/*.csproj'
  backend-any:
    needs: changes
    if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.backend-any == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "do backend-any"

  frontend-any:
    needs: changes
    if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.frontend-any == 'true' }}
    uses: ./.github/workflows/on-frontend-any.yaml

  #docfx-any:
  #  needs: changes
  #  if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.docfx-any == 'true' }}
  #  runs-on: ubuntu-latest
  #  steps:
  #    - run: echo "do docfx-any"

  backend-common-any:
    needs: changes
    if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.backend-common-any == 'true' }}
    uses: ./.github/workflows/on-backend-common-any.yaml
    secrets:
      REPO_ACCOUNT: ${{ secrets.REPO_ACCOUNT }}
      REPO_ACCESS_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}

  backend-fakes-any:
    needs: changes
    if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.backend-fakes-any == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "do backend-fakes-any"

  pnpm-lock:
    needs: changes
    if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.pnpm-lock == 'true' }}
    uses: ./.github/workflows/on-pnpm-lock.yaml

  csproj:
    needs: changes
    if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.csproj == 'true' }}
    uses: ./.github/workflows/on-csproj.yaml

  create-comment:
    if: ${{ always() && github.event_name == 'pull_request' }}
    needs: [ backend-any, frontend-any, backend-common-any, backend-fakes-any, pnpm-lock, csproj ]
    runs-on: ubuntu-latest
    outputs:
      comment: ${{ steps.comment.outputs.MERGED_COMMENT }}
    steps:
      - name: Create comment
        id: comment
        run: |
          MERGED_COMMENT=""
          FRONTEND_LICENSE_CHECK="${{ needs.pnpm-lock.outputs.license-check }}"
          if [ "$FRONTEND_LICENSE_CHECK" != "" ]; then
          MERGED_COMMENT+=$FRONTEND_LICENSE_CHECK
          MERGED_COMMENT+="\n"
          fi
          echo "MERGED_COMMENT=${MERGED_COMMENT}" > "$GITHUB_OUTPUT"

  output-comment:
    if: ${{ always() && github.event_name == 'pull_request' }}
    needs: create-comment
    uses: ./.github/workflows/comment-bot.yaml
    with:
      action_name: '🙏Code Summary'
      comment: ${{ needs.create-comment.outputs.comment }}
